<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>순찰 일지 상세 보기</title>
    <!-- 부트스트랩 CSS 로드 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .navbar {
            position: relative;
            width: 100%;
            z-index: 1001;
            padding: 30px 0;
            background-color: #fff;
            display: flex;
            justify-content: center;
        }
        .navbar-custom {
            padding-right: 50px;
            padding-left: 50px;
        }
        .navbar-nav {
            margin-left: auto;
        }
        .navbar-brand img {
            height: 100px;
            margin-right: 10px;
        }
        .navbar-nav .nav-link {
            color: black;
            font-size: 1.5rem;
            transition: color 0.3s;
            margin: 0 7px;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .navbar-nav .nav-link:hover {
            color: #ffc107 !important;
        }
        .navbar-brand .text-white {
            color: black;
            font-size: 1.9rem;
            font-family: 'Noto Sans KR', sans-serif;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #fff;
        }
        .header {
            background-color: #fff;
            padding: 50px 0;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }
        .header h1 {
            font-size: 2.5rem;
            color: #343a40;
        }
        .content {
            margin: 40px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .board_view {
            width: 90%;
            max-width: 1200px;
            margin-bottom: 20px;
            border-collapse: collapse;
        }
        .board_view th, .board_view td {
            border: 1px solid #dee2e6;
            padding: 10px;
            font-size: 1.2rem;
        }
        .board_view th {
            background-color: #f8f9fa;
            text-align: left;
        }
        .buttons {
            text-align: center;
            margin-top: 20px;
        }
        .buttons button {
            margin: 0 10px;
        }
        .btn-primary {
            background-color: rgb(68, 136, 244);
            color: white;
        }
        .btn-danger {
            background-color: #f4553d;
            color: white;
        }
        footer {
            margin-top: 100px;
            background-color: #f8f9fa;
            color: black;
            padding: 30px;
            text-align: center;
        }
        /* 사진 관련 스타일 */
        .log-image {
            width: 100%;
            max-width: 500px;
            height: auto;
            margin-top: 20px;
            border: 1px solid #dee2e6;
            padding: 10px;
        }
    </style>
</head>
<body>

<!-- 네비게이션 바 -->
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid navbar-custom">
        <a class="navbar-brand" href="#">
            <img src="../image/logo.png" alt="Crime Scene 로고" class="navbar-logo">
            <span class="text-white">Crime Scene</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" aria-current="page" href="../main/main.html">Home</a>
                <a class="nav-link" href="../notice/notice.html">소통하기</a>
                <a class="nav-link" href="../mapmain/mapmain.html">지도보기</a>
                <a class="nav-link" href="../chart/chart.html">범죄통계표</a>
                <a class="nav-link" href="../region/region.html">위험지역</a>
                <a class="nav-link" href="../record/record.html">기록일지</a>
            </div>
        </div>
    </div>
</nav>

<!-- 헤더 -->
<div class="header">
    <div class="container">
        <h1>순찰 일지 상세 보기</h1>
        <p>기록을 확인하세요</p>
    </div>
</div>

<!-- 순찰 일지 상세 내용 -->
<div class="container content">
    <table class="board_view">
        <tbody>
            <tr>
                <th>순찰 제목</th>
                <td id="logTitle"></td>
            </tr>
            <tr>
                <th>순찰 시간</th>
                <td id="logTime"></td>
            </tr>
            <tr>
                <th>순찰 구역</th>
                <td id="logAddress"></td>
            </tr>
            <tr>
                <th>관찰된 사항</th>
                <td id="logObservations"></td>
            </tr>
            <tr>
                <th>조치 사항</th>
                <td id="logActions"></td>
            </tr>
            <tr>
                <th>신고 내용</th> <!-- 신고 내용 추가 -->
                <td id="logReportContent"></td> <!-- 신고 내용 표시할 칸 -->
            </tr>
            <tr>
                <th>사진</th>
                <td><img id="logImage" class="log-image" src="#" alt="순찰 사진" /></td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 버튼 -->
<div class="buttons">
    <button class="btn btn-primary" id="backButton">목록</button>
    <button class="btn btn-primary" id="editButton">수정</button> <!-- 수정 버튼 추가 -->
    <button class="btn btn-danger" id="deleteButton">삭제</button> <!-- 삭제 버튼 -->
</div>

<!-- 푸터 -->
<footer>
    <p>경기도 용인시 처인구 용인대학로 134 | 민원전화 010-1234-5678</p>
    <p>© 2024 Crime Scene. All rights reserved.</p>
    <p>본 사이트는 졸업작품을 위해 임시적으로 개발된 사이트임을 알립니다.</p>
</footer>

<!-- Firebase SDK 로드 -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script>

<script>
    // Firebase 초기화
    const firebaseConfig = {
        apiKey: "AIzaSyD7g5DdSIGP7FB5Jjsejqjwd71HKjZK0XI",
        authDomain: "crime-scene-9a5f5.firebaseapp.com",
        projectId: "crime-scene-9a5f5",
        storageBucket: "crime-scene-9a5f5.appspot.com",
        messagingSenderId: "1056014636450",
        appId: "1:1056014636450:web:3ca8a4560bf0c135a7cefb"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage(); // Firebase Storage

    let currentUserUID = null;
    let logId = null;

    // URL에서 logId 파라미터 가져오기
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    logId = urlParams.get('logId'); // logId로 수정

    // 로그인 상태 확인
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            currentUserUID = user.uid;
            if (logId) {
                loadLogDetail(logId); // logId를 사용하여 일지 불러오기
            } else {
                alert('일지 정보가 없습니다.');
                window.location.href = 'record.html'; // logId가 없을 경우 목록 페이지로 이동
            }
        } else {
            window.location.href = 'login.html';
        }
    });

    // Firestore에서 순찰 일지 가져오기
    function loadLogDetail(logId) {
        db.collection('patrolLogs').doc(currentUserUID).collection('logs').doc(logId).get()
        .then((doc) => {
            if (doc.exists) {
                const logData = doc.data();
                document.getElementById('logTitle').innerText = logData.title;
                document.getElementById('logTime').innerText = `시작: ${logData.startTime}, 종료: ${logData.endTime}`;
                document.getElementById('logAddress').innerText = logData.detailedAddress;
                document.getElementById('logObservations').innerText = logData.observations;
                document.getElementById('logActions').innerText = logData.actions;
                document.getElementById('logReportContent').innerText = logData.reportContent; // 신고 내용 표시
                
                // 이미지 불러오기
                if (logData.imagePath) {
                    storage.refFromURL(logData.imagePath).getDownloadURL()
                    .then((url) => {
                        document.getElementById('logImage').src = url;
                        document.getElementById('logImage').style.display = 'block';
                    }).catch((error) => {
                        console.error('이미지 불러오기 오류:', error);
                    });
                } else {
                    document.getElementById('logImage').style.display = 'none'; // 이미지가 없으면 숨김
                }
            } else {
                alert('기록이 존재하지 않습니다.');
                window.location.href = 'record.html'; // 기록이 없을 경우 목록으로 이동
            }
        })
        .catch((error) => {
            console.error('일지 불러오기 오류:', error);
        });
    }

    // 목록으로 돌아가기
    document.getElementById('backButton').addEventListener('click', function() {
        window.location.href = 'record.html'; // 목록 페이지로 이동
    });

    // 수정 페이지로 이동
    document.getElementById('editButton').addEventListener('click', function() {
        window.location.href = `modify.html?logId=${logId}`; // 수정 페이지로 이동
    });

    // 삭제 기능
    document.getElementById('deleteButton').addEventListener('click', function() {
        if (confirm('정말 삭제하시겠습니까?')) {
            db.collection('patrolLogs').doc(currentUserUID).collection('logs').doc(logId).delete()
            .then(() => {
                alert('일지가 삭제되었습니다.');
                window.location.href = 'record.html'; // 삭제 후 목록 페이지로 이동
            })
            .catch((error) => {
                console.error('일지 삭제 중 오류:', error);
                alert('일지 삭제 중 오류가 발생했습니다.');
            });
        }
    });
</script>

<!-- 부트스트랩 JS 로드 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
