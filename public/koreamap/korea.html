<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>순찰 요청 글쓰기</title>
    <!-- 부트스트랩 CSS 로드 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .navbar {
            position: relative;
            width: 100%;
            z-index: 1001;
            padding: 30px 0;
            background-color: #fff;
            display: flex;
            justify-content: center;
        }

        .navbar-custom {
            padding-right: 50px;
            padding-left: 50px;
        }

        .navbar-nav {
            margin-left: auto;
        }

        .navbar-brand img {
            height: 100px;
            margin-right: 10px;
        }

        .navbar-nav .nav-link {
            color: black;
            font-size: 1.5rem;
            font-family: 'Noto Sans KR', sans-serif;
            transition: color 0.3s;
            margin: 0 7px;
        }

        .navbar-nav .nav-link:hover {
            color: #ffc107 !important;
        }

        .navbar-brand .text-white {
            color: black;
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 1.9rem;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #fff;
        }

        .header {
            background-color: #fff;
            padding: 50px 0;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #343a40;
        }

        .header p {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .container {
            margin-top: 50px;
        }

        .form-group label {
            font-weight: bold;
        }

        .form-text {
            color: #6c757d;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .file-input {
            position: relative;
            overflow: hidden;
        }

        .submit-btn {
            text-align: right;
        }

        #map {
            width: 100%;
            height: 350px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        footer {
            margin-top: 100px;
            background-color: #f8f9fa;
            color: black;
            padding: 30px;
            text-align: center;
        }
    </style>
</head>
<body>

<!-- 네비게이션 바 -->
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid navbar-custom">
        <a class="navbar-brand" href="#">
            <img src="../image/logo.png" alt="Crime Scene 로고" class="navbar-logo">
            <span class="text-white">Crime Scene</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" aria-current="page" href="../main/main.html">Home</a>
                <a class="nav-link" href="../notice/notice.html">소통하기</a>
                <a class="nav-link" href="../mapmain/mapmain.html">지도보기</a>
                <a class="nav-link" href="../chart/chart.html">범죄통계표</a>
                <a class="nav-link" href="../region/region.html">위험지역</a>
                <a class="nav-link" href="../record/record.html">기록일지</a>
            </div>
        </div>
    </div>
</nav>

<!-- 헤더 -->
<div class="header">
    <div class="container">
        <h1>순찰 요청 글쓰기</h1>
        <p>순찰 요청에 대한 글을 작성해주세요.</p>
    </div>
</div>

<div class="container">
    <form id="writeForm">
        <div class="mb-3 row">
            <label for="title" class="col-sm-2 col-form-label">제목 *</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="title" required>
            </div>
        </div>
        <div class="mb-3 row">
            <label for="nickname" class="col-sm-2 col-form-label">닉네임 *</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="nickname" required>
            </div>
        </div>
        <div class="mb-3 row">
            <label for="content" class="col-sm-2 col-form-label">내용 *</label>
            <div class="col-sm-10">
                <textarea class="form-control" id="content" rows="5" required></textarea>
                <small class="form-text">작성 제출 후 수정은 불가하고 삭제만 가능합니다.</small>
            </div>
        </div>

        <div class="mb-3 row">
            <label for="region" class="col-sm-2 col-form-label">지역 *</label>
            <div class="col-sm-10">
                <select class="form-select" id="region" required>
                    <option value="서울">서울</option>
                    <option value="인천">인천</option>
                    <option value="경기도">경기도</option>
                    <option value="강원도">강원도</option>
                    <option value="세종">세종</option>
                    <option value="대전">대전</option>
                    <option value="충청북도">충청북도</option>
                    <option value="경상북도">경상북도</option>
                    <option value="대구">대구</option>
                    <option value="울산">울산</option>
                    <option value="충청남도">충청남도</option>
                    <option value="부산">부산</option>
                    <option value="경상남도">경상남도</option>
                    <option value="전라북도">전라북도</option>
                    <option value="전라남도">전라남도</option>
                    <option value="광주">광주</option>
                    <option value="제주도">제주도</option>
                </select>
            </div>
        </div>

        <div class="mb-3 row">
            <label for="address" class="col-sm-2 col-form-label">상세 주소 *</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="address" required>
            </div>
        </div>

        <div class="mb-3 row">
            <label for="file" class="col-sm-2 col-form-label">사진 업로드</label>
            <div class="col-sm-10">
                <input type="file" class="form-control" id="file" accept="image/*">
            </div>
        </div>

        <!-- 지도 -->
        <input type="text" id="searchKeyword" placeholder="장소 검색">
        <button type="button" onclick="searchPlaces()">검색</button>
        <div id="map"></div>

        <div class="submit-btn">
            <button type="submit" class="btn btn-primary">등록</button>
        </div>
    </form>
</div>

<!-- 푸터 -->
<footer>
    <p>경기도 용인시 처인구 용인대학로 134 | 민원전화 010-1234-5678</p>
    <p>© 2024 Crime Scene. All rights reserved.</p>
    <p>본 사이트는 졸업작품을 위해 임시적으로 개발된 사이트임을 알립니다.</p>
</footer>

<!-- Firebase SDK 로드 -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script>

<!-- 카카오 맵 API 로드 -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=1b5eaa5f89dbc525e2d29d5c0911d1f9&libraries=services"></script>

<script>
// Firebase 초기화
const firebaseConfig = {
    apiKey: "AIzaSyD7g5DdSIGP7FB5Jjsejqjwd71HKjZK0XI",
    authDomain: "crime-scene-9a5f5.firebaseapp.com",
    projectId: "crime-scene-9a5f5",
    storageBucket: "crime-scene-9a5f5.appspot.com",
    messagingSenderId: "1056014636450",
    appId: "1:1056014636450:web:3ca8a4560bf0c135a7cefb"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// 카카오 맵 초기화
var mapContainer = document.getElementById('map'); 
var mapOption = { 
    center: new kakao.maps.LatLng(33.450701, 126.570667), // 기본 지도 좌표 설정
    level: 3 // 확대 레벨
};

var map = new kakao.maps.Map(mapContainer, mapOption);

// 장소 검색 및 마커 설정
var marker;
var selectedLatLng = null; // 선택된 마커 위치 저장

// 지도 더블 클릭 이벤트로 마커 설정
kakao.maps.event.addListener(map, 'dblclick', function(mouseEvent) {        
    var latlng = mouseEvent.latLng;
    
    // 기존 마커 제거
    if (marker) marker.setMap(null);
    
    // 새로운 마커 추가
    marker = new kakao.maps.Marker({
        position: latlng,
        map: map
    });

    // 선택된 좌표 저장
    selectedLatLng = latlng;
});

// 장소 검색
function searchPlaces() {
    var keyword = document.getElementById('searchKeyword').value;
    if (!keyword.trim()) {
        alert('검색어를 입력하세요!');
        return;
    }

    var ps = new kakao.maps.services.Places();
    ps.keywordSearch(keyword, placesSearchCB); 
}

// 검색 결과 콜백 함수
function placesSearchCB(data, status, pagination) {
    if (status === kakao.maps.services.Status.OK) {
        // 검색 결과의 첫 번째 장소로 이동
        var coords = new kakao.maps.LatLng(data[0].y, data[0].x);
        map.setCenter(coords);

        // 검색된 장소에 마커 추가
        if (marker) marker.setMap(null);
        marker = new kakao.maps.Marker({
            position: coords,
            map: map
        });

        // 선택된 좌표 업데이트
        selectedLatLng = coords;
    } else {
        alert('검색 결과가 없습니다.');
    }
}

// 제출 시 마커와 폼 데이터를 함께 저장
document.getElementById('writeForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const title = document.getElementById('title').value;
    const nickname = document.getElementById('nickname').value;
    const content = document.getElementById('content').value;
    const region = document.getElementById('region').value;
    const address = document.getElementById('address').value;
    const file = document.getElementById('file').files[0];
    const date = firebase.firestore.Timestamp.now(); // Firestore의 Timestamp 타입으로 현재 시간을 저장

    if (!selectedLatLng) {
        alert('위치를 선택해주세요.');
        return;
    }

    if (file) {
        const storageRef = storage.ref();
        const fileRef = storageRef.child('uploads/' + file.name);

        fileRef.put(file).then(() => {
            fileRef.getDownloadURL().then((url) => {
                addPostToFirestore(title, nickname, content, region, address, selectedLatLng.getLat(), selectedLatLng.getLng(), date, url);
            });
        }).catch((error) => {
            console.error('Error uploading file: ', error);
        });
    } else {
        addPostToFirestore(title, nickname, content, region, address, selectedLatLng.getLat(), selectedLatLng.getLng(), date, null);
    }
});

function addPostToFirestore(title, nickname, content, region, address, lat, lng, date, imageUrl) {
    db.collection('patrolRequests').add({
        제목: title,
        닉네임: nickname,
        내용: content,
        지역: region,
        주소: address,
        위도: lat,
        경도: lng,
        날짜: date,
        이미지: imageUrl || ''
    }).then(() => {
        alert('등록 완료되었습니다.');
        window.location.href = "map.html";
    }).catch((error) => {
        console.error('Error adding document: ', error);
    });
}
</script>

<!-- 부트스트랩 JS 로드 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</body>
</html>
